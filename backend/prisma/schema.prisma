generator client {
  provider = "prisma-client-js"
  engineType = "library"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

// Enums are replaced by Strings because SQLite does not support Enum types.

// User Model
model User {
  id            String   @id @default(uuid())
  email         String   @unique
  telegramId    String?  @unique
  passwordHash  String?
  displayName   String?
  avatarUrl     String?
  role          String   @default("USER")
  tier          String   @default("SILVER")
  balance       Float    @default(0.0)
  rewardPoints  Int      @default(0)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relationships
  offersAsSeller     Offer[]       @relation("SellerOffers")
  transactionsAsBuyer Transaction[] @relation("BuyerTransactions")
  reviewsWritten      Review[]     @relation("AuthorReviews")
  messagesSent        Message[]    @relation("SenderMessages")
}

// Offer / Product Model
model Offer {
  id                String        @id @default(uuid())
  title             String
  description       String
  price             Float         @default(0.0) // 0.0 means free
  discountPercent   Int?          @default(0)
  vendorLogo        String?
  usageInstructions String?
  category          String
  isExclusive       Boolean       @default(false) // If true, only for Gold/Platinum
  hiddenData        String        // The actual promo code, link, or credentials
  isActive          Boolean       @default(true)
  isFlashDrop       Boolean       @default(false)
  expiresAt         DateTime?     // Expiration date for temporary promos
  sellerId          String
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt

  seller      User          @relation("SellerOffers", fields: [sellerId], references: [id])
  transactions Transaction[]
  reviews      Review[]
}

// Transaction (Escrow & Purchase)
model Transaction {
  id        String            @id @default(uuid())
  offerId   String
  buyerId   String
  price     Float
  status    String            @default("PENDING")
  createdAt DateTime          @default(now())
  updatedAt DateTime          @updatedAt

  offer     Offer @relation(fields: [offerId], references: [id])
  buyer     User  @relation("BuyerTransactions", fields: [buyerId], references: [id])
  dispute   Dispute?
}

// Subscription / Tier History (Optional)
model Subscription {
  id        String   @id @default(uuid())
  userId    String
  tier      String
  startDate DateTime @default(now())
  endDate   DateTime
  isActive  Boolean  @default(true)
}

// Review Model
model Review {
  id        String   @id @default(uuid())
  rating    Int      @default(5) // 1 to 5
  comment   String?
  offerId   String
  authorId  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  offer  Offer @relation(fields: [offerId], references: [id])
  author User  @relation("AuthorReviews", fields: [authorId], references: [id])
}

// Dispute Model
model Dispute {
  id            String   @id @default(uuid())
  transactionId String   @unique
  reason        String
  status        String   @default("OPEN") // OPEN, RESOLVED, CLOSED
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  transaction   Transaction @relation(fields: [transactionId], references: [id])
  messages      Message[]
}

// Chat Message Model
model Message {
  id        String   @id @default(uuid())
  disputeId String
  senderId  String
  text      String
  createdAt DateTime @default(now())

  dispute   Dispute @relation(fields: [disputeId], references: [id])
  sender    User    @relation("SenderMessages", fields: [senderId], references: [id])
}
